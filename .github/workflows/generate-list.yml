name: Generate File List

on:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Generate files.json
        run: |
          python3 << 'EOF'
          import os
          import json

          ignore = ['.git', '.github', 'index.html', 'LICENSE', 'README.md', '.gitignore', 'files.json']
          files = []

          for root, dirs, filenames in os.walk('.'):
              dirs[:] = [d for d in dirs if d not in ignore and not d.startswith('.')]
              for d in dirs:
                  path = os.path.join(root, d)[2:]
                  files.append({"name": path, "type": "dir"})
              for f in filenames:
                  if f not in ignore and not f.startswith('.'):
                      path = os.path.join(root, f)[2:]
                      files.append({"name": path, "type": "file"})

          files.sort(key=lambda x: x["name"])

          with open('files.json', 'w', encoding='utf-8') as f:
              json.dump(files, f, ensure_ascii=False, indent=2)
          EOF
          
      - name: Commit files.json
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add files.json
          git diff --staged --quiet || git commit -m "Update file list"
          git push
